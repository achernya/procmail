
#$Id: autoconf,v 2.4 1991/06/20 09:54:14 berg Rel $

SHELL=/bin/sh || exec /bin/sh autoconf $1 # we're in a csh, feed myself to sh

# All possible entries in autoconf.h:
#
#	#define const
#	#define volatile
#	#define void char
#	typedef int mode_t;
#	typedef int pid_t;
#	typedef unsigned size_t;
#	typedef long time_t;
#	#define NOmemmove
#	#define NObcopy
#	#define NOstrstr
#	#define strtol(str,ptr,base) ((long)atoi(str))

PATH=:$PATH
export SHELL
ACONF=autoconf.h
trap "exit 1" 1 2 3 15

cat >grepfor <<HERE
if fgrep "\$1" _autotst.rrr >/dev/null
then
 echo "\$2" >>$ACONF
 exit 0
fi
exit 1
HERE
chmod 0755 grepfor

cat >$ACONF <<HERE
/* This file was automagically generated by autoconf */

HERE

# WARNING: in ./include/stdlib.h the const keyword is already used!
#	   hence the const test has to precede all others.

cat >_autotst.c <<HERE
main(){const char*p;const char*q;
 p="t";q=p;return 0;}
HERE

echo 'Testing for const'
make _autotst.$1 >_autotst.rrr 2>&1
rm -f _autotst.$1

grepfor const '#define const'

cat >_autotst.c <<HERE
main(){volatile int i;return 0;}
HERE
 
echo 'Testing for volatile'
if make _autotst.$1 >/dev/null 2>&1
then
:
else
 echo '#define volatile' >>$ACONF
fi
rm -f _autotst.$1

cat >_autotst.c <<HERE
main(){int i;i= -1;return i=-i;}
HERE

echo 'Testing for compiler age'
make _autotst >_autotst.rrr 2>&1

if _autotst
then
 echo 'Aha, this one is genuine antique!'
 echo '#define void char' >>$ACONF
fi
rm -f _autotst _autotst.$1


cat >_autotst.c <<HERE
#include "includes.h"
main(){int i;
 void*p;
 i=(size_t)1;
 i+=(pid_t)1;
 i+=(time_t)1;
 i+=(mode_t)1;
 return 0;}
HERE

echo 'Testing for void*,size_t,pid_t,time_t,mode_t'
make _autotst.$1 >_autotst.rrr 2>&1
rm -f _autotst.$1

grepfor void '#define void char'
grepfor size_t 'typedef unsigned size_t;'
grepfor pid_t 'typedef int pid_t;'
grepfor time_t 'typedef long time_t;'
grepfor mode_t 'typedef int mode_t;'

cat >_autotst.c <<HERE
#include "includes.h"
main(){char a[2];
 setpwent();endpwent();memmove(a,"0",1);bcopy("0",a,1);strstr(a,"0");
 strtol("0",(char**)0,10);return 0;}
HERE

echo 'Testing for memmove, strstr & strtol'
make _autotst.$1 >/dev/null 2>&1
make _autotst >_autotst.rrr 2>&1
rm -f _autotst _autotst.$1

grepfor memmove '#define NOmemmove' && grepfor bcopy '#define NObcopy'
grepfor strstr '#define NOstrstr'
grepfor setpwent '#define setpwent()'
grepfor endpwent '#define endpwent()'
grepfor strtol '#define strtol(str,ptr,base) ((long)atoi(str))'

rm -f _autotst* grepfor

echo -----------------------------autoconf.h-----------------------------------
cat autoconf.h
echo --------------------------------------------------------------------------
