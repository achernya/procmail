#!/bin/sh
#$Id: autoconf,v 2.1 1991/06/11 12:59:16 berg Rel $

SHELL=/bin/sh || exec /bin/sh <autoconf # we're in a csh, feed myself to sh

ACONF=autoconf.h
trap "rm $ACONF;exit 1" 1 2 3 15
cat >$ACONF <<HERE
/* This file was automagically generated by autoconf */

HERE

# WARNING: in ./include/stdlib.h the const keyword is already used!
#	   hence the const test has to precede all others.

cat >_autotst.c <<HERE
main(){const int i;return 0;}
HERE

echo 'Testing for const'
if make _autotst >/dev/null 2>&1
then
:
else
 echo '#define const' >>$ACONF
fi
rm -f _autotst _autotst.o

cat >_autotst.c <<HERE
main(){volatile int i;return 0;}
HERE
 
echo 'Testing for volatile'
if make _autotst >/dev/null 2>&1
then
:
else
 echo '#define volatile' >>$ACONF
fi
rm -f _autotst _autotst.o

cat >_autotst.c <<HERE
main(){int i;i= -1;return i=-i;}
HERE

echo 'Testing for compiler age'
make _autotst >_autotst.rrr 2>&1

if _autotst
then
 echo 'Aha, this one is genuine antique!'
 echo '#define void char' >>$ACONF
fi
rm -f _autotst _autotst.o


cat >_autotst.c <<HERE
#include "includes.h"
main(){int i;
 void*p;
 i=(size_t)1;
 i+=(pid_t)1;
 i+=(time_t)1;
 i+=(mode_t)1;
 return 0;}
HERE

echo 'Testing for void*,size_t,pid_t,time_t,mode_t'
make _autotst >_autotst.rrr 2>&1
rm -f _autotst _autotst.o

grepfor(){
if fgrep "$1" _autotst.rrr >/dev/null
then
 echo "$2" >>$ACONF
fi
}

grepfor void '#define void char'
grepfor size_t 'typedef unsigned size_t;'
grepfor pid_t 'typedef int pid_t;'
grepfor time_t 'typedef long time_t;'
grepfor mode_t 'typedef int mode_t;'

cat >_autotst.c <<HERE
#include "includes.h"
main(){char a[1];
 setpwent();endpwent();memmove(a,"t",1);bcopy("t",a,1);strstr(a,"t");return 0;}
HERE

echo 'Testing for memmove & strstr'
make _autotst >_autotst.rrr 2>&1
rm -f _autotst _autotst.o

if fgrep memmove _autotst.rrr >/dev/null
then
 echo '#define NOmemmove' >>$ACONF
 grepfor bcopy '#define NObcopy'
fi
grepfor strstr '#define NOstrstr'
grepfor setpwent '#define setpwent()'
grepfor endpwent '#define endpwent()'

rm -f _autotst*

echo -----------------------------autoconf.h-----------------------------------
cat autoconf.h
echo --------------------------------------------------------------------------
